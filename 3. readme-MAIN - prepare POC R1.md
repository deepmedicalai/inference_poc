
# Copy necessary files to Main PI

## Create directory on raspberry device

```
export INSTALL_DIR="/root/init"
ssh pi@192.168.1.106 "sudo mkdir $INSTALL_DIR"

```

## Copy files to Raspberry PI device

### Copy runtime files to PI device

Enter your IP address of Raspberry PI address. 

```
tar -c -C ./setup-main/init-files . | ssh pi@192.168.1.106 "sudo tar -x --no-same-owner -C $INSTALL_DIR"
```

You can verify that scripts where copied by SSH to Raspberry device and checking files
```
ssh pi@192.168.1.106
sudo -i
cd /root/init
ls
head ./update-os.sh
```

### Set permissions on files 

Set execute permissions on necessary files
```
sudo -i
cd /root/init
chmod +x download-opencv.sh update-os.sh build-opencv.sh
```

## Build OpenCV

### Login as interactive root

```
ssh pi@192.168.1.106
sudo -i
cd ~

```

### Download openCV
```
$ cd ~
$ ./init/download-opencv.sh
```

### Update OS and install OpenCV deps

It can take 5-10 minutes

```
$ cd ~
$ ./init/update-os.sh
```

### Create a large SWAP file
```
$ sudo dphys-swapfile swapoff
$ sudo sed -i 's:CONF_SWAPSIZE=.*:CONF_SWAPSIZE=2048:g' /etc/dphys-swapfile
$ sudo /etc/init.d/dphys-swapfile stop
$ sudo /etc/init.d/dphys-swapfile start
```


### Build OpenCV
It will take up to 1 hour. 
```
$ ./init/build-opencv.sh
$ cd ~/opencv/opencv-4.1.0/build
$ sudo make install
```

### Test OpenCV

```
$ cd ~
$ wget "https://upload.wikimedia.org/wikipedia/en/7/7d/Lenna_%28test_image%29.png" -O lenna.jpg
$ python3 ./init/test-opencv.py lenna.jpg
```


## Building and installed TF2 Beta

### Set execute permissions on necessary files
Set execute permissions on necessary files (originally files were copied already)
```
sudo -i
cd /root/init
chmod +x prep-for-tf2.sh download-and-install-tf2.sh
```
### Run preparation/download files for TF2

```
$ sudo -i
$ cd ~
$ ./init/prep-for-tf2.sh

```

### Install TF2 build 
You can read more here: https://github.com/PINTO0309/Tensorflow-bin

```
$ sudo -i
$ cd ~
$ ./init/download-and-install-tf2.sh
```

## Install Redis


### Install package
```
apt -y install redis-server
```

### Configure redis to start on boot
```
sudo systemctl enable --now redis-server.service
```

## Install SQLite
```
apt-get install sqlite3
```

## Installing Edge Python

### Prepare files
```
$ sudo cd ~/init
$ sudo chmod +x ./prep-edge-tpu.sh
```

### Download Edge TPU libraries

```
$ cd ~
$ sudo ./init/prep-edge-tpu.sh
$ sudo cp ~/init/updated-edge-install.sh ~/edge/edgetpu_api/
$ sudo chmod +x ~/edge/edgetpu_api/updated-edge-install.sh
```

### Install Patched version


from here: https://github.com/leswright1977/RPi4-Google-Coral

also forcing maximum performance (can get HOT) without asking

```
$ sudo ~/edge/edgetpu_api/updated-edge-install.sh
```
You may have to answer "Y"

## Copy Python files


### Create directory on raspberry device
on Mac
```
export MAIN_DIR="/root/main"
ssh pi@192.168.1.106 "sudo mkdir $MAIN_DIR"

```



### Copy python runtime files to PI device

Enter your IP address of Raspberry PI address. 

```
tar -c -C ./main_src . | ssh pi@192.168.1.106 "sudo tar -x --no-same-owner -C $MAIN_DIR"
```

### Install PIP3 dependencies
```
cd ~/main
pip3 install -r web-requirements.txt -r worker-requirements.txt
```

### Create test directories
```
cd ~/main
mkdir test
cd test
mkdir incoming
mkdir processing
```


### test webserver
```
cd ~/main
export APP_SETTINGS="settings.config.DeviceDevelopmentConfig"
python3 manage.py run -h 0.0.0.0
```

### test worker
```
cd ~/main
export APP_SETTINGS="settings.config.DeviceDevelopmentConfig"
python3 manage.py run_worker
```


### Send test DICOMs to incoming folder

On Mac


```
export INCOMING_DIR="/root/main/test/incoming"
tar -c -C ./main/test/incoming . | ssh pi@192.168.1.106 "sudo tar -x --no-same-owner -C $INCOMING_DIR"
```

Enter session id from current postman processing and let it copy DCM files to session folder
```
$ sudo export SESSION_ID=51800
$ sudo cd ~/main/test/incoming
$ sudo cp *.dcm "./${SESSION_ID}"
```

Now you can initiate processing of files in Postman



